// The easiest way to load webpage assets using WebTorrent
// TODO: turn into NPM package on its own

// quick WebRTC check
function testRTC() {
  var test = window.RTCSessionDescription;
  if (String(testRTC) == 'undefined') {
    return false
  }
  return true
}

// important to keep track of the blob urls to refer to when determining order of injection for dependencies' sake
var blobs = [];

function fillSrc(element, source) {
  element.setAttribute('src', source)
}

function loadTorResource(element, infohash, cb) {
  // check if blob is already loaded / loading
  if (!blobs.hasOwnProperty(infohash)) {
    var torClient = new WebTorrent()
    console.log("before: " + infohash)
    
    torClient.add(infohash, function (torrent) {
      blobs[infohash] = ""; // marker that indicates file is loading
      console.log("after: " + infohash)
      
      // torrent.addWebSeed(depend['location']);  // not sure if we want this
      torrent.on('done', function() {
        // WebTorrents can contain many files. Let's use the first.
        var file = torrent.files[0];

        // tbh, don't know what the var does, but the function is useful
        var flubber = file.getBlobURL(function (err, url) {
          if (err) throw err
          blobs[infohash] = url;
          cb(element, blobs[infohash]);
        });
      });

    });
  }
  else {
    cb(element, blobs[infohash])
  }

}

// main
var elements = document.getElementsByClassName("tormedia")
var torSrc = ""
for(var i=0; i < elements.length; i++){
  var link = elements[i].getAttribute('href')
  if (testRTC()) {
    var infohash = elements[i].getAttribute('infohash')
    // var infohash = 'https://webtorrent.io/torrents/sintel.torrent'
    loadTorResource(elements[i], infohash, fillSrc)
  }
  else {
    fillSrc(elements[i], link)
  }
}
